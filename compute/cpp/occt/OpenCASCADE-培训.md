# OpenCASCADE

[TOC]

## 简介

开源C++库，提供曲面和实体建模，面向制造和工业领域的精确建模，提供可视化，公开文件格式交换，提供快速开发框架，用于CAD CAM CAE，使用LGPL协议开源；1999年由Matra开源；

该内核用于很多产品，韩国的MIDAS，结构专业TEKLA，CF turbo，船舶CADMATIC，西门子西班牙FORAN；

我们可以使用 其开发自己的CAD产品；

### 前置要求

设计模式、C++ 、数学几何、数值分析、计算几何；

### 书籍推荐

#### 入门

《Introduction to solid modeling 》by Martti Mantyla

《Solid modelling and cad systems》 by Ian Stroud and Hildegarde Nagy 

《Parameteric and Feature Based CAD /CAM Concepts techniques and applicaitons》 by jami j shah and  Martti Mantyla

#### B样条

《A practical guide to splines》 by Carl de Boor

《The BURBS Book》 by les Piegl and Wayne Tiller 

《geometric modeling》 by Nikolay Golovanov  作者 尼古莱 戈洛瓦诺夫 为 俄罗斯几何核心库 C3D 的开发者

### 安装包所含内容

自动文档，开发人员文档
有关 MFC C# QT JAVA web 示例  
强大的测试程序



### 安装编译

一般跨平台的编译需要使用CMAKE，而源码中也包含了针对windows的bat编译脚本
对于这类较为复杂的库推荐为window下针对VS编译；

第三方库简要介绍：

FREEIMAGE 用于贴图等功能
FFMPEG 用于操作录像功能
TBB 因特尔多线程库
VTK 很强大的可视化工具库 在这里用于有限元后处理
LIBLZMA 压缩文件库
RAPIDJSON json文件的处理库
TCLTK 处理工具箱 必须配置的库
FREETYPE 显示文字的库  为必须配置的库

这些库的开关选项 都在 custom.bat 文件中 ；具体路径

```
ROOT\OpenCASCADE-7.4.0-vc14-64\opencascade-7.4.0\custom.bat
```

内容大致如下，在不同的开发环境下路径和少数选项有所区别

```bat
@echo off
rem This environment file was generated by genconf.tcl script at 2020.09.07 23:15

set PRJFMT=vcxproj
rem 为VS的版本 可以向下兼容
set VCVER=vc142
rem 32 or 64
set ARCH=64
set VCVARS=C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\vcvarsall.bat
set SHORTCUT_HEADERS=ShortCut

set "PRODUCTS_PATH="

rem Optional 3rd-parties switches
set HAVE_FREEIMAGE=true
set HAVE_FFMPEG=true
set HAVE_TBB=false
set HAVE_GLES2=false
set HAVE_D3D=false
set HAVE_VTK=false
set HAVE_ZLIB=false
set HAVE_LIBLZMA=false
set HAVE_E57=false
set HAVE_RAPIDJSON=true
set HAVE_OPENCL=false
set CHECK_QT4=false
set CHECK_JDK=false
set HAVE_RelWithDebInfo=true

rem Additional headers search paths  include
set "CSF_OPT_INC=D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/freetype-2.5.5-vc14-64/include;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/freeimage-3.17.0-vc14-64/include;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/ffmpeg-3.3.4-64/include;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/tcltk-86-64/include;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/rapidjson-1.1.0/include"

rem Additional libraries (32-bit) search paths
set "CSF_OPT_LIB32="

rem Additional libraries (64-bit) search paths  lib
set "CSF_OPT_LIB64=D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/freetype-2.5.5-vc14-64/lib;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/ffmpeg-3.3.4-64/lib;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/tcltk-86-64/lib;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/freeimage-3.17.0-vc14-64/lib"

rem Additional (32-bit) search paths
set "CSF_OPT_BIN32="

rem Additional (64-bit) search paths  bin
set "CSF_OPT_BIN64=D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/tcltk-86-64/bin;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/freeimage-3.17.0-vc14-64/bin;D:/_PRO/_DEVELOPER/OpenCASCADE-7.4.0-vc14-64/freetype-2.5.5-vc14-64/bin"

```



| VC-VERSION | VS VERSION | WINDOWS |      |
| ---------- | ---------- | ------- | ---- |
| VC10       | 2010       | desktop |      |
| VC11       | 2012       | desktop |      |
| VC12       | 2013       | desktop |      |
|            |            |         |      |
| VC14       | 2015       | desktop |      |
| VC14-UWP   | 2015       | UWP     |      |
| VC141      | 2017       | desktop |      |
| VC141-UWP  | 2017       | UWP     |      |
| VC142      | 2019       | desktop |      |
| VC142-UWP  | 2019       | UWP     |      |



### 编码规范

查看 sample documented class Package_Class 文件和类
查看 occt_contribution_coding_rules.pdf

工具集前缀TK
类名称： <package-name>_<class-name>
知名见意：局部变量 aWidthOfBox  函数参数 theWidth



### 模块概览

<img src="../../OpenCASCADE-培训.assets/image-20230225135637079.png" alt="image-20230225135637079" style="zoom:50%;" />

<img src="../../OpenCASCADE-培训.assets/image-20230225142833099.png" alt="image-20230225142833099" style="zoom:50%;" />

##### 基础库 foundation class

其中基础类给OCCT提供了数据结构和功能

其自己定义数组，文件读写，字符串处理等；

##### 数学库 TKMATH

BVH 空间层级划分，ELCLib一般几何，ELSlib面几何，EXPR表达式求解

##### 几何表达法 modleling-data

TKBRep  边界表示法 
TKG2d 二维曲线
TKG3d 三维曲线曲面
TKGeomBase 基础几何库

##### 算法库

TKBool 布尔运算
TKGeomAlgo 算法
TKHLR 隐藏线消 工程图常用
TKMesh 自定义网格
TKOffset 扫掠放样
TKPrime 基本几何建模

TKTopAlgo 拓扑工具

##### 显示库

TKOpenGL TKOpenGLes TKIVtk 等都是显示功能

##### 信息交互库 data exchange 

TKSTEP TKIGES TKSTL TKVRML 等都是标准文件的输入和输出

快速框架 application framework

数据框架 持久化 undo-redo 

##### Draw Test 

支持TCL脚本建模，用于测试



### 几何造型

分为参数化和解析化的几何；参数化的几何放在Geom包内，可转为解析化；解析化的几何在gp前缀的包内；

解析化的几何只能表达基本形状，无法表达自由任意的曲面；

参数化几何可以做复杂的形态，但是对于知道点反求参数运算较慢；

在文件中有提供基本的几何建立程序 具体路径为

```
ROOT\OpenCASCADE-7.4.0-vc14-64\opencascade-7.4.0\draw.bat
```

此处若出现未加载dll的情况，需要把第三方库编译好的dll复制进入opencascade的目录下；

首先看看

以直线为例，参数方程为  $C(u)=P+u\cdot D,u\in(-\infty,\infty)$   ，比如   $经过点(1,0,3),方向 (0,1,0)$  直线方程为  $C(u)=(1,0,3)+u \cdot (0,1,0)$

以圆为例
参数化为 $C(u)=P+r\cdot(\cos u\cdot D_x+\sin u\cdot D_y),u\in[0,2\pi),D_x，D_y 为xy轴方向，r为半径$
解析化为 $x^2+y^2=r^2$

可见知道一个点是否在曲线上，在解析式中直接通过点坐标可算得，而在参数式中需要通过其他额外的方法进行计算；

椭圆为例  参数式为  $C(u) = P+r_{maj}\cos u\cdot D_{maj}+r_{min}\sin u\cdot D_{min},u\in[0,2\pi)$

抛物线为例  $C(u)=P+\frac{u^2}{4f}\cdot D_x+uD_y,u\in(-\infty,\infty),f \neq 0,f为焦点长度$

双曲线  $C(u)=P +k_x\cosh u\cdot D_x+k_y\sinh u\cdot D_y,u\in(-\infty,\infty)$

贝塞尔曲线  $C(u)=\frac{\sum\limits^m_{i=0}B_ih_iC^i_mu^i(1-u)^{m-i}}{\sum\limits^m_{i=0}h_iC^i_mu^i(1-u)^{m-i}}.u\in[0,1]$  软件中很好的封装为了一元函数

draw.bat中的操作

```shell
#适配画面
fit
#直线绘制
line 1 1 0  3 0 1 0
#圆
circle c 1 2 3 0 0 1 4
#抛物线
parabola p 1 2 3 0 0 1 46
#双曲线
hyperbola h 1 2 3 0 0 1 5 4

```

  

```shell
#进入三维空间
vinit
#建立box
box b 1 2 3
#实体显示
vdisplay b
```



Trimmed Curve 可裁剪参数几何的曲线上下限

$C(u)=B(u),u\in[u_{min},u_{max}]$

offset curve偏移曲线是基线加上偏移方向和距离

$C(u)=B(u)+D\frac{B'(u),D}{|B'(u),D|},u\in domain(B)$



其他具体形状 略

## 边界表示法 B-Rep

TopoDS用于定义抽象的几何元素

为何使用边界表达法
CSG 构造实体建模，但是无法任意建模、线框可能有二义性、图纸仅是二维的、Mesh没有精确表达法；
所以采用边界表达法来没有二义性的表达任意几何体；

B-Rep缺点是不稳定、且较为复杂；

抽象top定义了 

|           |        |
| :-------- | ------ |
| vertex    | 点     |
| edge      | 线     |
| wire      | 框     |
| face      | 面     |
| shell     | 壳     |
| solid     | 体     |
| compsolid | 体组合 |
| compound  | 任组合 |

其组合形式是类似树图；

### 各表示细节

几何表示其实没有想象那么简单，其不同形成性质在相关数据都会保存

### BRep_TVertex 点的表示

点通常会有多种表达法可能是某一个曲线限定处，或者曲线相交处，或者某个面的UV处，点在保存的时候，所有相关数据都会保存
比如纯粹空间点，直接保存坐标即可；
比如线上一点 保存内容为：该曲线，取点参数；
比如线与面交点保存内容为：该曲线，该曲面，取点参数；
比如面上的点保存内容为：该曲面，U参数，V参数；

### BRep_TEdge 边的表示

边可能是一个曲线和两个点的限定，也可能是面上曲线

曲线限定保存内容为：该曲线，点1，点2
面上曲线的保存内容为：该参数曲线，曲线参数1，曲线参数2，曲面，U，V

### BRep_TFace 面的表示

面的表达很简单；就保存为一个限定的曲面即可；



### 精度问题

顶点精度>边精度>面精度









































































































